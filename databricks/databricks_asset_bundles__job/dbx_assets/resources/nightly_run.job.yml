resources:
  jobs:
    ScheduledELT:
      name: ScheduledELT
      email_notifications:
        on_failure:
          - 1a23456b.data-cubed.co.uk@uk.teams.ms
        on_duration_warning_threshold_exceeded:
          - 1a23456b.data-cubed.co.uk@uk.teams.ms
      timeout_seconds: 9000
      health:
        rules:
          - metric: RUN_DURATION_SECONDS
            op: GREATER_THAN
            value: 5400
      schedule:
        quartz_cron_expression: 48 0 6 * * ?
        timezone_id: Europe/London
      tasks:
        - task_key: Refresh_SP_DevopsToken
          notebook_task:
            notebook_path: /Workspace/Shared/RefreshServicePrincipalGitConfig
            source: WORKSPACE
          existing_cluster_id: ${var.cluster_id}
        - task_key: ADF_Orchestration
          depends_on:
            - task_key: mcs_ddl
          notebook_task:
            notebook_path: scripts/ingestion/mcs/ADF Orchestration
            source: GIT
          existing_cluster_id: ${var.cluster_id}
        - task_key: Bronze_Layer_Dataload
          depends_on:
            - task_key: ADF_Orchestration
          notebook_task:
            notebook_path: scripts/ingestion/mcs/mcs_landing_zone_ingestion
            source: GIT
          existing_cluster_id: ${var.cluster_id}
        - task_key: dbt_Run
          depends_on:
            - task_key: Bronze_Layer_Dataload
          dbt_task:
            project_directory: dbt_transformations
            commands:
              - dbt deps
              - dbt seed
              - dbt run --select processed
              - dbt test --select processed
              - dbt run --select modelled.dim_model
              - dbt test --select modelled.dim_model
              - dbt run --select modelled.reporting
              - dbt test --select modelled.reporting
            warehouse_id: ${var.sql_warehouse_id}
            source: GIT
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - pypi:
                package: dbt-databricks>=1.0.0,<2.0.0
            - pypi:
                package: databricks-sql-connector==4.2.4
            - pypi:
                package: dbt-databricks==1.10.14
      git_source:
        git_url: https://github.com/data-cubed/client-wernick-elt.git
        git_provider: gitHub
        git_branch: ${var.git_branch_name}
      queue:
        enabled: true
